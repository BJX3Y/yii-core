# パフォーマンス・プロファイリング

パフォーマンスのボトルネックを探し出して、それに応じた適切な対策を取るためには、コードのプロファイリングをしなければなりません。
プロファイリングとは、あるコード・ブロックの実行に要する時間とメモリを計測することです。

パフォーマンス・プロファイリングを使用するためには、最初に、プロファイリングが必要なコード・ブロックを特定します。
そして、各コード・ブロックを次のように囲みます。

```php
\Yii::beginProfile('myBenchmark');

... プロファイリングされるコード・ブロック ...

\Yii::endProfile('myBenchmark');
```

ここで `myBenchmark` はコード・ブロックを特定するユニークなトークンを表します。
後でプロファイリング結果を検査するときに、このトークンを使って、対応するコード・ブロックによって消費された時間を調べます。

`beginProfile` と `endProfile` のペアが適正な入れ子になっていることを確認することが非常に重要なことです。
例えば、

```php
\Yii::beginProfile('block1');

    // プロファイリングされる何らかのコード

    \Yii::beginProfile('block2');
        // プロファイリングされる別のコード
    \Yii::endProfile('block2');

\Yii::endProfile('block1');
```

`\Yii::endProfile('block1')` を忘れたり、`\Yii::endProfile('block1')` と `\Yii::endProfile('block2')` の順序を入れ替えたりすると、
パフォーマンス・プロファイリングは機能しません。

プロファイリングの結果は、[Yii デバッガ](https://github.com/yiisoft/yii2-debug/blob/master/docs/guide/README.md)
に内蔵されたパフォーマンス・プロファイリング・パネルで見たり、
プロファイリング用に構成されたターゲットに送信したりすることが出来ます。

## プロファイラのターゲットを構成する

Yii デバッガの使用に加えて、プロファイリングのメッセージをログその他のターゲットに送信したいでしょう。
そうするためには、アプリケーション構成によってプロファイリングのターゲットを構成する必要があります。

```php
return [
    'profiler' => [
        'targets => [
            '__class' => /yii/profile/LogTarget::class,
        ],
    ],
];
```

プロファイラの `LogTarget` が構成されると、プロファイルされるコード・ブロックごとに、重要度レベルが `debug` であるログ・メッセージが記録されます。

## その他のツール

原則として全ての呼び出しをプロファイルする必要がある場合には、低レベルのツールを使うというのが良いアイデアです。

### XDebug プロファイラ

XDebug がインストール済みであれば、その [内蔵のプロファイラ](http://xdebug.org/docs/profiler) を使うことが出来ます。
ただし、XDebug を有効にするとアプリケーションの実行速度を顕著に遅くしますので、
プロファイリングの結果は正確さを欠いて、実運用環境には適用できないものになることに注意して下さい。

### XHProf

[XHProf](http://www.php.net/manual/ja/book.xhprof.php) は、開発環境および実運用環境での使用を意図したオープン・ソリューションです。
パフォーマンスに大きな影響を与えません。結果を分析するためのいくつかの GUI が存在します。

### Blackfire

[Blackfire](https://blackfire.io/) は商用の PHP プロファイラです。XHProf と同様、パフォーマンスに影響を与えません。
データを分析する UI は SAAS ソリューションとして提供されています。
